!function(){"use strict";var n=function(e,t,n){return e+n*(t-e)},s=function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")},r=function(){function i(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(e,t,n){return t&&i(e.prototype,t),n&&i(e,n),e}}(),o=function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)},a=function(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t},d=function(e,t){if(Array.isArray(e))return e;if(Symbol.iterator in Object(e))return function(e,t){var n=[],i=!0,r=!1,s=void 0;try{for(var o,a=e[Symbol.iterator]();!(i=(o=a.next()).done)&&(n.push(o.value),!t||n.length!==t);i=!0);}catch(e){r=!0,s=e}finally{try{!i&&a.return&&a.return()}finally{if(r)throw s}}return n}(e,t);throw new TypeError("Invalid attempt to destructure non-iterable instance")},u=function(){function h(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:h.getRandomSeed(),t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:h.getRandomTime(),n=2<arguments.length&&void 0!==arguments[2]?arguments[2]:h.getRandomSharpness();s(this,h),this.seed=e,this.time=t,this.sharpness=n}return r(h,[{key:"randomize",value:function(){this.seed=h.getRandomSeed(),this.time=h.getRandomTime(),this.sharpness=h.getRandomSharpness()}},{key:"toString",value:function(){return this.seed+"|"+this.time+"|"+this.sharpness}}],[{key:"getRandomSeed",value:function(){return Math.floor(n(h.SEED_MIN,h.SEED_MAX,Math.random()))}},{key:"getRandomTime",value:function(){var e=Math.pow(10,h.TIME_PRECISION),t=n(h.TIME_MIN,h.TIME_MAX,Math.random());return Math.floor(t*e)/e}},{key:"getRandomSharpness",value:function(){return Math.floor(n(h.SHARPNESS_MIN,h.SHARPNESS_MAX,Math.random()))}},{key:"parse",value:function(e){var t=e.split(/\|/g),n=d(t,3),i=n[0],r=n[1],s=n[2],o=Number.parseInt(i),a=Number.parseFloat(r),u=Number.parseInt(s);return Number.isNaN(o)||Number.isNaN(a)||Number.isNaN(u)?null:new h(o,a,u)}},{key:"SEED_MIN",get:function(){return 0}},{key:"SEED_MAX",get:function(){return Math.floor(.5*Number.MAX_SAFE_INTEGER)}},{key:"TIME_MIN",get:function(){return-8}},{key:"TIME_MAX",get:function(){return 8}},{key:"TIME_PRECISION",get:function(){return 4}},{key:"SHARPNESS_MIN",get:function(){return 0}},{key:"SHARPNESS_MAX",get:function(){return Math.pow(2,12)}}]),h}(),i=function(){function e(){s(this,e),this._handlers={}}return r(e,[{key:"off",value:function(e,t){if("string"!=typeof e)throw new Error('Event "'+e+'" is not a string');if("function"!=typeof t)throw new Error('Handler "'+t+'" is not a function');if(Object.values(this._handlers[e]).includes(t)){var n=this._handlers[e].indexOf(t);this._handlers[e].splice(n)}else console.warn('Handler "'+t+'" is not a registered function')}},{key:"on",value:function(e,t){if("string"!=typeof e)throw new Error('Event "'+e+'" is not a string');if("function"!=typeof t)throw new Error('Handler "'+t+'" is not a function');e in this._handlers||(this._handlers[e]=[]),this._handlers[e].push(t)}},{key:"trigger",value:function(e){for(var t=arguments.length,n=Array(1<t?t-1:0),i=1;i<t;i++)n[i-1]=arguments[i];e in this._handlers&&this._handlers[e].forEach(function(e){return e.apply(void 0,n)})}}]),e}(),t=new(function(e){function t(){s(this,t);var e=a(this,(t.__proto__||Object.getPrototypeOf(t)).call(this));return window.addEventListener("hashchange",function(){return e.trigger("change")}),e}return o(t,i),r(t,[{key:"getRenderSettings",value:function(){return window.location.hash?u.parse(window.location.hash.substr(1)):null}},{key:"persist",value:function(e){if(!(e instanceof u))throw new Error('"'+e+'" should be of type RenderSettingsModel');window.location.hash=e.toString()}}]),t}()),h=function(e){function n(e){s(this,n);var t=a(this,(n.__proto__||Object.getPrototypeOf(n)).call(this));return t.element=e,t}return o(n,i),r(n,[{key:"dispose",value:function(){}},{key:"getComponentElement",value:function(e){return this.element.querySelector('[data-component="'+e+'"]')}},{key:"getElement",value:function(e){return this.element.querySelector('[data-ref="'+e+'"]')}}]),n}(),c=function(){function o(e,t,n){s(this,o),this.model=o.createModel(e,t,n)}return r(o,[{key:"predict",value:function(t){var n=this;return tf.tidy(function(){var e=n.model.predict(t.expandDims(0)).add(tf.scalar(1)).mul(tf.scalar(.5));return tf.unstack(e).pop()})}}],[{key:"createModel",value:function(e,t,n){var i=tf.initializers.varianceScaling({distribution:"normal",mode:"fanIn",scale:n,seed:t}),r=tf.input({shape:[e,e,4]}),s=o.createDensityTopology(r,i);return s=tf.layers.dense({activation:"tanh",kernelInitializer:tf.initializers.glorotNormal({seed:t}),units:3}).apply(s),tf.model({inputs:r,outputs:s})}},{key:"createDensityTopology",value:function(e,t){for(var n=2<arguments.length&&void 0!==arguments[2]?arguments[2]:8,i=3<arguments.length&&void 0!==arguments[3]?arguments[3]:8,r=0;r<n;r++){var s=tf.layers.dense({activation:"sigmoid",kernelInitializer:t,units:i}).apply(e);e=tf.layers.concatenate({}).apply([e,s])}return e}}]),o}(),l=function(e){function t(e){s(this,t);var r=a(this,(t.__proto__||Object.getPrototypeOf(t)).call(this));return r._isRunning=!1,r._messageId=-1,r._messagesInProgress=new Set,r._queue=[],r._worker=new Worker(e),r._worker.addEventListener("message",function(e){var t=e.data,n=t.id,i=t.message;r._isRunning=!1,r._messagesInProgress.has(n)&&(r._messagesInProgress.delete(n),r.trigger("message",i))}),r}return o(t,i),r(t,[{key:"clear",value:function(){this._isRunning=!1,this._messagesInProgress.clear(),this._queue=[]}},{key:"createMessageId",value:function(){return this._messageId===Number.MAX_SAFE_INTEGER&&(this._messageId=-1),++this._messageId}},{key:"run",value:function(){this._isRunning||this.isEmpty||(this._isRunning=!0,this._worker.postMessage(this._queue.shift()))}},{key:"queue",value:function(e){var t=this.createMessageId();this._messagesInProgress.add(this._messageId),this._queue.push({id:t,message:e}),this.run()}},{key:"isEmpty",get:function(){return 0===this._queue.length}},{key:"queueSize",get:function(){return this._queue.length}}]),t}(),g=function(e){function g(e,t){s(this,g);var r=a(this,(g.__proto__||Object.getPrototypeOf(g)).call(this,e));return r.context=r.element.getContext("2d"),r.settingsComponent=t,r.canvasSegment=document.createElement("canvas"),r.canvasSegment.height=g.SEGMENT_SIZE,r.canvasSegment.width=g.SEGMENT_SIZE,r._segmentCount=0,r._segmentQueue=new l("assets/workers/input-data.js?_="+Date.now()),r._segmentQueue.on("message",function(e){var t=e.data,n=e.xOffset,i=e.yOffset;r._render(t,n,i).then(function(){var e=r._segmentQueue.queueSize;r.trigger("progress",(r._segmentCount-e)/r._segmentCount),r._segmentQueue.isEmpty?r.trigger("finish"):r._segmentQueue.run()})}),r}return o(g,h),r(g,[{key:"download",value:function(){var e=this.settingsComponent,t=e.height,i=e.seed+"-"+e.time+"-"+e.sharpness+"-"+e.width+"x"+t+".png";this.context.canvas.toBlob(function(e){if("msSaveBlob"in window.navigator)window.navigator.msSaveBlob(e,i);else{var t=(window.URL||window.webkitURL).createObjectURL(e),n=document.createElement("a");n.style.display="none",n.download=i,n.href=t,document.body.appendChild(n),n.click(),requestAnimationFrame(function(){document.body.removeChild(n),(window.URL||window.webkitURL).revokeObjectURL(t)})}},"image/png")}},{key:"start",value:function(){var e=g.SEGMENT_OFFSET,t=g.SEGMENT_SIZE,n=this.settingsComponent,i=n.height,r=n.seed,s=n.sharpness,o=n.width,a=Math.ceil(o/e),u=Math.ceil(i/e);this._segmentCount=a*u,this._segmentQueue.clear(),this.element.height=i,this.element.width=o,this.model=new c(g.SEGMENT_SIZE,r,s),this.trigger("start");for(var h=0;h<this._segmentCount;h++){var d=h%a*e,l=Math.floor(h/a)*e;this._segmentQueue.queue({height:i,xOffset:d,yOffset:l,size:t,time:this.settingsComponent.time,width:o})}this._segmentQueue.run()}},{key:"_render",value:function(e,t,n){var i=this,r=tf.tidy(function(){return i.model.predict(tf.tensor(e,g.SEGMENT_SHAPE))});return tf.toPixels(r,this.canvasSegment).then(function(){return i.context.drawImage(i.canvasSegment,t,n)})}}],[{key:"SEGMENT_SIZE",get:function(){return 256}},{key:"SEGMENT_OFFSET",get:function(){return g.SEGMENT_SIZE-2}},{key:"SEGMENT_SHAPE",get:function(){return[g.SEGMENT_SIZE,g.SEGMENT_SIZE,4]}}]),g}(),f=function(e){function n(e){s(this,n);var t=a(this,(n.__proto__||Object.getPrototypeOf(n)).call(this,e));return t.elementProgress=t.getElement("report-progress"),t.elementTimeRemaining=t.getElement("report-time-remaining"),t.timePrevious=0,t}return o(n,h),r(n,[{key:"start",value:function(){this.timeElapsed=0,this.timePrevious=performance.now(),this.update(0)}},{key:"update",value:function(e){var t=performance.now(),n=(t-this.timePrevious)/1e3;this.timeElapsed+=n;var i,r=(1-e)*(0<e?1/e*this.timeElapsed:1/0);this.elementProgress.innerText=(100*e).toFixed(2)+"%",this.elementTimeRemaining.innerText="~"+((i=r)===1/0?"forever":i<60?i.toFixed(0)+"s":i<3600?(i/60).toFixed(0)+"m":(i/3600).toFixed(2)+"h")+" remaining",this.timePrevious=t}}]),n}(),m=function(){function n(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:320,t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:320;s(this,n),this.height=t,this.width=e}return r(n,[{key:"setResolutionFromString",value:function(e){var t=e.split(/x/g).map(function(e){return Number.parseInt(e)}),n=d(t,2),i=n[0],r=n[1];r&&i&&(this.height=r,this.width=i)}}]),n}(),_=function(e){function i(e){s(this,i);var t=a(this,(i.__proto__||Object.getPrototypeOf(i)).call(this,e));t._inputHeight=t.element.elements.height,t._inputHeight.min=1,t._inputWidth=t.element.elements.width,t._inputWidth.min=1,t._inputSeed=t.element.elements.seed,t._inputSeed.max=u.SEED_MAX,t._inputSeed.min=u.SEED_MIN,t._inputSeed.step=1,t._inputTime=t.element.elements.time,t._inputTime.step=1/Math.pow(10,u.TIME_PRECISION),t._inputSharpness=t.element.elements.sharpness,t._inputSharpness.max=u.SHARPNESS_MAX,t._inputSharpness.min=u.SHARPNESS_MIN,t._buttonRandomize=t.element.elements.randomize,t._imageSettings=new m,t._renderSettings=new u,t._updateFields();var n=function(e){var t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:100,n=void 0;return function(){n&&clearTimeout(n),n=setTimeout(function(){return e()},t)}}(t._handleInputUpdate.bind(t));return t.element.addEventListener("input",function(e){e.target!==t._inputSeed&&e.target!==t._inputTime&&e.target!==t._inputSharpness||n()}),t.element.addEventListener("change",function(e){e.target!==t._inputWidth&&e.target!==t._inputHeight||n()}),t.element.addEventListener("click",function(e){"resolution-preset"===e.target.name&&(t._imageSettings.setResolutionFromString(e.target.dataset.resolution),t.trigger("change"))}),t._buttonRandomize.addEventListener("click",function(){return t._randomize()}),t}return o(i,h),r(i,[{key:"update",value:function(){t.getRenderSettings()&&(this._renderSettings=t.getRenderSettings()),this._updateFields()}},{key:"persist",value:function(){t.persist(this._renderSettings)}},{key:"_handleInputUpdate",value:function(){this.element.reportValidity()&&(this._hydrate(),this.persist(),this.trigger("change"))}},{key:"_hydrate",value:function(){this._renderSettings.seed=Number.parseInt(this._inputSeed.value),this._renderSettings.time=Number.parseFloat(this._inputTime.value),this._renderSettings.sharpness=Number.parseInt(this._inputSharpness.value),this._imageSettings.height=Number.parseInt(this._inputHeight.value),this._imageSettings.width=Number.parseInt(this._inputWidth.value)}},{key:"_randomize",value:function(){this._renderSettings.randomize(),this.persist(),this.trigger("change")}},{key:"_updateFields",value:function(){this._inputSeed.value=this._renderSettings.seed,this._inputTime.value=this._renderSettings.time,this._inputSharpness.value=this._renderSettings.sharpness,this._inputHeight.value=this._imageSettings.height,this._inputWidth.value=this._imageSettings.width}},{key:"height",get:function(){return this._imageSettings.height}},{key:"seed",get:function(){return this._renderSettings.seed}},{key:"time",get:function(){return this._renderSettings.time}},{key:"sharpness",get:function(){return this._renderSettings.sharpness}},{key:"width",get:function(){return this._imageSettings.width}}]),i}(),e=new(function(e){function n(e){s(this,n);var t=a(this,(n.__proto__||Object.getPrototypeOf(n)).call(this,e));return t._buttonDownload=t.getElement("button-download"),t._rendererReport=new f(t.getComponentElement("image-renderer-report")),t._settings=new _(t.getComponentElement("settings")),t._settings.on("change",function(){return t.restart()}),t._settings.update(),t._renderer=new g(t.getComponentElement("image-renderer"),t._settings),t._renderer.on("start",function(){t._rendererReport.start(),t._buttonDownload.disabled=!0}),t._renderer.on("progress",function(e){t._rendererReport.update(e)}),t._renderer.on("finish",function(){t._rendererReport.update(1),t._buttonDownload.disabled=!1}),t._buttonDownload.addEventListener("click",function(){t._buttonDownload.disabled||t._renderer.download()}),t}return o(n,h),r(n,[{key:"restart",value:function(){this._settings.update(),this.start()}},{key:"start",value:function(){this._settings.persist(),this._renderer.start()}}]),n}())(document.querySelector('[data-component="app"]'));e.start(),t.on("change",function(){return e.restart()}),window.addEventListener("beforeunload",function(){return e.stop()})}();
